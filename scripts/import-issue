#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "PyGithub",
# ]
# ///
"""
Import a GitHub issue from anthropics/claude-code into the issues directory.

Usage: ./scripts/import-issue.py <issue-number>

Creates: issues/<issue-number>-<slug>/
  - ISSUE.md with frontmatter and issue body
  - README.md with overview template
"""

import os
import re
import sys
from datetime import datetime, timezone
from pathlib import Path

from github import Github

REPO_NAME = "anthropics/claude-code"


def slugify(title: str, max_length: int = 50) -> str:
    """Convert title to a filename-safe slug."""
    # Lowercase and replace spaces with hyphens
    slug = title.lower().replace(" ", "-")
    # Remove non-alphanumeric characters (except hyphens)
    slug = re.sub(r"[^a-z0-9-]", "", slug)
    # Collapse multiple hyphens
    slug = re.sub(r"-+", "-", slug)
    # Truncate and strip trailing hyphens
    return slug[:max_length].rstrip("-")


def main():
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <issue-number>")
        print(f"Example: {sys.argv[0]} 1234")
        sys.exit(1)

    try:
        issue_number = int(sys.argv[1])
    except ValueError:
        print(f"Error: '{sys.argv[1]}' is not a valid issue number")
        sys.exit(1)

    # Get GitHub token from environment
    token = os.environ.get("GITHUB_TOKEN")
    if not token:
        print("Error: GITHUB_TOKEN environment variable not set")
        sys.exit(1)

    # Connect to GitHub
    g = Github(token)
    repo = g.get_repo(REPO_NAME)

    print(f"Fetching issue #{issue_number} from {REPO_NAME}...")

    try:
        issue = repo.get_issue(issue_number)
    except Exception as e:
        print(f"Error: Could not fetch issue #{issue_number}: {e}")
        sys.exit(1)

    # Build directory path
    slug = slugify(issue.title)
    issue_dir = Path("issues") / f"{issue_number}-{slug}"

    # Check if already exists
    if issue_dir.exists():
        print(f"Issue already exists at: {issue_dir}")
        sys.exit(0)

    # Create directory
    issue_dir.mkdir(parents=True, exist_ok=True)

    # Get labels
    labels = ", ".join(label.name for label in issue.labels)
    labels_yaml = ", ".join(f'"{label.name}"' for label in issue.labels)

    # Write ISSUE.md
    issue_md = issue_dir / "ISSUE.md"
    imported_at = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")

    issue_md.write_text(f'''---
title: "{issue.title}"
source_repo: {REPO_NAME}
issue_number: {issue_number}
github_issue: {issue.html_url}
labels: [{labels_yaml}]
state: {issue.state}
imported: {imported_at}
---

# {issue.title}

{issue.body or "_No description provided._"}
''')

    # Write README.md
    readme_md = issue_dir / "README.md"
    readme_md.write_text(f'''---
title: "{issue.title}"
github_issue: {issue.html_url}
state: {issue.state}
---

# {issue.title}

**GitHub Issue**: {issue.html_url}
**State**: {issue.state}
**Labels**: {labels or "_none_"}

## Notes

_Add your analysis and notes here._
''')

    print(f"Imported issue #{issue_number} to: {issue_dir}")
    print("Files created:")
    print(f"  - {issue_md}")
    print(f"  - {readme_md}")


if __name__ == "__main__":
    main()
